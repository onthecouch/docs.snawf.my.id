# Gateway & Monitor Setup (Oracle Cloud)

**Role:** High-Availability Gateway & Monitor  
**Instance Name:** `util-node-01`  
**OS:** Ubuntu 22.04 Minimal (ARM64)

---

## 1. Infrastructure Provisioning

The instance is provisioned within the Oracle "Always Free" tier, utilizing minimal resources to reserve capacity for the primary Kubernetes cluster.

| Component | Specification | Notes |
| :--- | :--- | :--- |
| **Shape** | VM.Standard.A1.Flex | ARM-based Ampere processor |
| **CPU / RAM** | 1 OCPU / 4 GB RAM | ~25% of monthly free allowance |
| **Boot Volume** | 47 GB (Default) | the ~153GB for k3s use |
| **Networking** | Reserved Public IP | Attached to Primary VNIC |

---

## 2. OS Initialization & System Prep

Initial system hardening, firewall configuration, and resource management.

### SSH Access
```bash
# Keyfile: ssh-key-2026-01-06.key
ssh -i "ssh-key-2026-01-06.key" ubuntu@my.public.ip
```

### System Prep & Firewall Flush
Oracle's default `iptables` rules must be flushed to allow Docker container networking.

```bash
sudo -i
apt update && apt upgrade -y

# Flush firewall rules
iptables -F && netfilter-persistent save

# Install dependencies
apt install -y curl wget git htop stress-ng cron
```

---

## 3. Network Tunneling (Tailscale)

Establishes a secure mesh network for connectivity with the home lab.

1.  **Installation:**
    ```bash
    curl -fsSL https://tailscale.com/install.sh | sh
    ```
2.  **Authentication:** Authenticate via the console link to join the "Home Lab" mesh.
3.  **Verification:** Run `tailscale ping <home-server>` to confirm connectivity.
4.  **DNS Override:** Set Global Nameserver to `100.xxx.xxx.xxx` (Self) to enforce AdGuard blocking.

---

## 4. Application Stack (Docker Compose)

Services are deployed via Docker Compose in the `/opt/docker` directory.

### Directory Structure
```bash
mkdir -p /opt/docker/{npm,adguard,kuma,syncthing}
```

### Service Configuration (`docker-compose.yml`)
Note the use of `network_mode: host` for AdGuard and Syncthing to ensure proper network visibility.

```yaml
services:
  # 1. Nginx Proxy Manager (Gateway)
  npm:
    image: 'jc21/nginx-proxy-manager:latest'
    container_name: npm
    restart: unless-stopped
    ports:
      - '80:80'   # HTTP
      - '81:81'   # Admin Dashboard
      - '443:443' # HTTPS
    volumes:
      - ./npm/data:/data
      - ./npm/letsencrypt:/etc/letsencrypt

  # 2. AdGuard Home (DNS Sinkhole)
  adguard:
    image: 'adguard/adguardhome'
    container_name: adguard
    restart: unless-stopped
    network_mode: host
    volumes:
      - ./adguard/work:/opt/adguardhome/work
      - ./adguard/conf:/opt/adguardhome/conf

  # 3. Uptime Kuma (Monitoring)
  kuma:
    image: 'louislam/uptime-kuma:1'
    container_name: kuma
    restart: unless-stopped
    ports:
      - '3001:3001'
    volumes:
      - ./kuma:/app/data

  # 4. Syncthing (File Sync)
  syncthing:
    image: 'syncthing/syncthing'
    container_name: syncthing
    restart: unless-stopped
    network_mode: host
    environment:
      - PUID=0
      - PGID=0
    volumes:
      - ./syncthing/config:/var/syncthing/config
      - ./syncthing/data:/var/syncthing
```

---

## 5. Service Configuration

Post-deployment configuration fixes.

### AdGuard Home: Port Conflict
AdGuard and Nginx Proxy Manager both default to Port 80. Remap AdGuard to avoid conflict.

1.  **File:** `/opt/docker/adguard/conf/AdGuardHome.yaml`
2.  **Change:** Update `port: 80` to `port: 8083`.
3.  **Restart:** `docker restart adguard`

### Uptime Kuma: Public Status Page
1.  **Domain:** `status.snawf.my.id`
2.  **Upstream:** `kuma` (Container Name) on Port `3001`.
3.  **SSL:** Generate Let's Encrypt certificate via Nginx Proxy Manager.

