# Kubernetes Master Setup (Oracle Cloud)

**Role:** Production Cluster (K3s)  
**Instance Name:** `k3s-master`  
**OS:** Ubuntu 22.04 Minimal (ARM64)

---

## 1. Infrastructure Provisioning

The instance is provisioned within the Oracle "Always Free" tier, maximizing the remaining allocation to support container orchestration and database workloads.

| Component | Specification | Notes |
| :--- | :--- | :--- |
| **Shape** | VM.Standard.A1.Flex | Ampere (ARM64) Architecture |
| **OCPU** | 3 Cores | 75% of total free tier allowance |
| **RAM** | 20 GB | Optimized for databases and monitoring stacks |
| **Storage** | 150 GB | Custom boot volume size (Maximized) |
| **Network** | Reserved Public IP | Required for consistent `kubectl` access |
| **Firewall** | Ingress Rules | Added TCP `6443` (API) & `80/443` (Web) |

---

## 2. OS Initialization & Firewall Fix

Standard system hardening and network configuration. Oracle's default `iptables` rules are overly restrictive and block Pod-to-Pod communication, so they must be flushed before installing K3s.

### SSH Access and Updates
```bash
ssh ubuntu@my.public.ip
sudo -i

apt update && apt upgrade -y
```

### Firewall Configuration
The following commands flush existing rules and set default policies to ACCEPT. This relies on the Oracle Cloud Security List (VCN Firewall) for actual packet filtering.

```bash
# Flush restrictive Oracle rules
iptables -F
iptables -X

# Set default policies
iptables -P INPUT ACCEPT
iptables -P FORWARD ACCEPT
iptables -P OUTPUT ACCEPT

# Ensure persistence across reboots
apt install -y netfilter-persistent
netfilter-persistent save
```

---

## 3. Cluster Bootstrap (K3s)

We install K3s with the `--tls-san` flag to ensure the generated TLS certificate includes the public IP address. This allows secure remote access via `kubectl`.

### Server-Side Installation
```bash
curl -sfL https://get.k3s.io | sh -s - --tls-san 168.110.214.104 --write-kubeconfig-mode 644
```

---

## 4. Local Client Configuration

To access the cluster from a local machine (e.g., Windows), retrieve the `kubeconfig` file from `/etc/rancher/k3s/k3s.yaml` on the server and update the endpoint.

1.  **Copy Config:** Save the file locally as `oracle-k3s.yaml`.
2.  **Edit Endpoint:** Change the server URL from localhost to the public IP.
    *   **From:** `server: https://127.0.0.1:6443`
    *   **To:** `server: https://168.110.214.104:6443`
3.  **Verify Connection:**
    ```powershell
    kubectl get nodes --kubeconfig=oracle-k3s.yaml
    ```
