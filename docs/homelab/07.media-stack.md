# 111 - Media-VM (Jellyfin/Arr Stack)

**Role:** Automated Media Acquisition & Streaming  
**VM ID:** `111` (configured as 200 in guide) | **IP:** `10.10.10.118`  
**OS:** Debian 12 (Optimized Netinst)

---

### 1\. Proxmox VM Creation (Web UI)

_Optimized hardware profile for Debian 12 and iGPU passthrough._

| Component | Specification | Notes |
| --- | --- | --- |
| **OS Template** | Debian 12 (Bookworm) | Minimal Netinst (No GUI) |
| **Machine** | q35 / OVMF (UEFI) | Required for PCI Passthrough |
| **vCPU** | 2 Cores (Type: Host) | NUMA Disabled (Saves RAM) |
| **RAM** | 3072 MB | Ballooning Disabled |
| **Storage (OS)** | 32 GB | Bus: SCSI / Discard Enabled |
| **Storage (Data)** | 6TB External HDD | Mounted via VirtIO-FS (`media`) |
| **Network** | VirtIO Bridge | Static IPv4: `10.10.10.118/24` |
| **GPU** | Intel UHD Graphics | Full PCI Passthrough (00:02.0) |

---

### 2\. Base OS Configuration

_Minimalist installation for SSH management and media drivers._

#### A. Initial VM Shell Tasks

```bash
# Update and install core drivers
apt update && apt upgrade -y
apt install -y curl ca-certificates gnupg2 sudo vainfo intel-media-va-driver
# Grant root privileges to user
usermod -aG sudo youruser
```

#### B. Storage Passthrough (6TB External HDD)

_Configuring VirtIO-FS for high-speed local disk access._

1.  **Proxmox Host Shell:** `nano /etc/pve/qemu-server/200.conf`
2.  **Add Entry:** `mp0: /mnt/media,mp=/mnt/media`
3.  **Proxmox Web UI (Bypass CLI):** Hardware > Add > VirtIO-FS (Directory: `/mnt/media`, Tag: `media`).
4.  **Verification (VM):** `ls /mnt/media`

---

### 3\. Intel iGPU Passthrough (VA-API)

_Hardware configuration for native transcoding performance._

#### A. Host Configuration (Proxmox Shell)

1.  **BIOS:** Enable `VT-x` and `VT-d` in UEFI settings.
2.  **GRUB:** `nano /etc/default/grub` -> `GRUB_CMDLINE_LINUX_DEFAULT="quiet intel_iommu=on iommu=pt"`
3.  **Update:** `update-grub` && `reboot`.
4.  **Verify IOMMU:** `dmesg | grep -e DMAR -e IOMMU` (Should see: `IOMMU enabled`).
5.  **Modules:** Add `vfio`, `vfio_iommu_type1`, `vfio_pci`, `vfio_virqfd` to `/etc/modules`.

#### B. VM Attachment & Verification (VM Shell)

1.  **Identify GPU:** `lspci | grep VGA` (Example: `00:02.0`).
2.  **VM Config:** Add `hostpci0: 0000:00:02.0,pcie=1,x-vga=1` to `/etc/pve/qemu-server/200.conf`.
3.  **Install VM Drivers:** `sudo apt install -y intel-media-va-driver-non-free i965-va-driver-shaders vainfo`.
4.  **Verify:** `ls -l /dev/dri` (Must see `card0`, `renderD128`) and `vainfo` for profile listings.

---

### 4\. Docker Engine & Stack Installation

_Standardized container environment for the "Arr" suite._

#### A. Install Docker

```bash
# GPG & Repository
sudo mkdir -p /etc/apt/keyrings
curl -fsSL [https://download.docker.com/linux/debian/gpg](https://download.docker.com/linux/debian/gpg) | sudo gpg --dearmor -o /etc/apt/keyrings/docker.gpg
echo "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.gpg] [https://download.docker.com/linux/debian](https://download.docker.com/linux/debian) $(lsb_release -cs) stable" | sudo tee /etc/apt/sources.list.d/docker.list > /dev/null

# Installation
sudo apt update && sudo apt install -y docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin
sudo systemctl enable --now docker
sudo usermod -aG docker $USER
```

#### B. Directory & Permission Prep

```bash
MEDIA_DIR=/mnt/media
mkdir -p $MEDIA_DIR/config/{jellyfin,radarr,sonarr,lidarr,prowlarr,bazarr,qbittorrent}
mkdir -p $MEDIA_DIR/{movies,tv,music,downloads}
chown -R 1000:1000 $MEDIA_DIR && chmod -R 775 $MEDIA_DIR
```

#### C. Docker Compose Configuration (`~/docker/docker-compose.yml`)

_Configured with PUID/PGID 1000 and mapped to the 6TB mount._

```yaml
services:
  jellyfin:
    image: lscr.io/linuxserver/jellyfin:latest
    container_name: jellyfin
    network_mode: host
    environment: { PUID: 1000, PGID: 1000, TZ: Asia/Jakarta }
    volumes:
      - /mnt/media/config/jellyfin:/config
      - /mnt/media/movies:/movies
      - /mnt/media/tv:/tv
      - /mnt/media/music:/music
      - /mnt/media/downloads:/downloads
    devices:
      - /dev/dri:/dev/dri  # Intel iGPU Passthrough
    restart: unless-stopped

  radarr:
    image: lscr.io/linuxserver/radarr:latest
    container_name: radarr
    environment: { PUID: 1000, PGID: 1000, TZ: Asia/Jakarta }
    volumes:
      - /mnt/media/config/radarr:/config
      - /mnt/media/movies:/movies
      - /mnt/media/downloads:/downloads
    ports: [ "7878:7878" ]

  sonarr:
    image: lscr.io/linuxserver/sonarr:latest
    container_name: sonarr
    environment: { PUID: 1000, PGID: 1000, TZ: Asia/Jakarta }
    volumes:
      - /mnt/media/config/sonarr:/config
      - /mnt/media/tv:/tv
      - /mnt/media/downloads:/downloads
    ports: [ "8989:8989" ]

  # Additional services (Lidarr, Prowlarr, Bazarr, qBittorrent) follow same volume/UID pattern.
```

### 5\. Service Optimization & RAM Management

_Critical tuning for a 3GB RAM environment._

- **Jellyfin Hardware Acceleration:** Dashboard > Playback > Hardware acceleration: âœ” VAAPI | Device: `/dev/dri/renderD128`.
- **Trimming:** Disable Intro detection, Real-time monitoring, and Chapter image extraction.
- **Jellyfin Resource Limit:** `systemctl edit jellyfin` -> Add `[Service] MemoryMax=2500M`.
- **Optimization Settings:** Transcode limit: 2 | Prefer Direct Play.

---

### 6\. Networking & Proxy Integration

_Migration steps to integrate with existing LXC infrastructure._

- **Nginx Proxy Manager:** Map upstream to `http://10.10.10.118:8096` (Jellyfin) and respective ports for the Arr stack.
- **Internal Resolution:** Use AdGuard Home for DNS rewrites, ensuring all services remain functional without service breakage.